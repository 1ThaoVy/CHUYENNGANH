<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒê∆°n h√†ng - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#06B6D4' } } }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 text-white">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center space-x-3 mb-2">
                    <span class="text-3xl">üîê</span>
                    <h1 class="text-2xl font-bold">Orianna<br>Admin</h1>
                </div>
                <p class="text-sm text-gray-400">Qu·∫£n tr·ªã vi√™n</p>
            </div>
            <nav class="px-4">
                <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 mb-2">
                    <span class="text-xl">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="manage-products.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 mb-2">
                    <span class="text-xl">üì¶</span>
                    <span>S·∫£n ph·∫©m</span>
                </a>
                <a href="orders.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-gray-700 mb-2">
                    <span class="text-xl">üõí</span>
                    <span>ƒê∆°n h√†ng</span>
                </a>
                <a href="manage-categories.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 mb-2">
                    <span class="text-xl">üè∑Ô∏è</span>
                    <span>Danh m·ª•c</span>
                </a>
                <a href="#" onclick="alert('Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn'); return false;" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 mb-2 opacity-50">
                    <span class="text-xl">üë•</span>
                    <span>Kh√°ch h√†ng</span>
                </a>
                <a href="#" onclick="alert('Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn'); return false;" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 mb-2 opacity-50">
                    <span class="text-xl">‚öôÔ∏è</span>
                    <span>C√†i ƒë·∫∑t</span>
                </a>
                <a href="../index.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 mb-2 mt-8">
                    <span class="text-xl">üè†</span>
                    <span>V·ªÅ trang ch·ªß</span>
                </a>
                <button onclick="logout()" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-red-700 bg-red-600 mb-2 mt-2">
                    <span class="text-xl">üö™</span>
                    <span>ƒêƒÉng xu·∫•t</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8">
            <div class="mb-8">
                <h2 class="text-3xl font-bold mb-2">Qu·∫£n l√Ω ƒê∆°n h√†ng</h2>
                <p class="text-gray-600">Xem v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng</p>
            </div>

            <!-- Filter -->
            <div class="mb-6 flex gap-4">
                <select id="status-filter" class="px-4 py-2 border rounded-lg">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="1">Ch·ªù x·ª≠ l√Ω</option>
                    <option value="2">ƒê√£ x√°c nh·∫≠n</option>
                    <option value="3">ƒêang giao h√†ng</option>
                    <option value="4">ƒê√£ ho√†n th√†nh</option>
                    <option value="5">ƒê√£ h·ªßy</option>
                </select>
            </div>

            <!-- Orders Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div id="orders-table" class="overflow-x-auto">
                    <p class="p-6 text-gray-500">ƒêang t·∫£i...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Update Status Modal -->
    <div id="status-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6">C·∫≠p nh·∫≠t tr·∫°ng th√°i</h3>
            <form id="status-form">
                <input type="hidden" id="order-id">
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2">Tr·∫°ng th√°i m·ªõi</label>
                    <select id="trang_thai_don_hang_id" required class="w-full px-4 py-2 border rounded-lg">
                        <option value="1">Ch·ªù x·ª≠ l√Ω</option>
                        <option value="2">ƒê√£ x√°c nh·∫≠n</option>
                        <option value="3">ƒêang giao h√†ng</option>
                        <option value="4">ƒê√£ ho√†n th√†nh</option>
                        <option value="5">ƒê√£ h·ªßy</option>
                    </select>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-primary hover:bg-cyan-600 text-white py-2 rounded-lg font-semibold">
                        C·∫≠p nh·∫≠t
                    </button>
                    <button type="button" onclick="closeStatusModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 rounded-lg font-semibold">
                        H·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="admin-auth.js"></script>
    <script>
        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '../login.html';
            }
        }
    </script>
    <script>
        let allOrders = [];

        async function loadOrders() {
            try {
                const data = await apiCall('/orders/admin/all');
                allOrders = data.data;
                displayOrders(allOrders);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('orders-table').innerHTML = 
                    '<p class="p-6 text-red-500">L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message + '</p>';
            }
        }

        function displayOrders(orders) {
            const table = document.getElementById('orders-table');
            
            if (orders.length === 0) {
                table.innerHTML = '<p class="p-6 text-gray-500">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</p>';
                return;
            }

            table.innerHTML = `
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">M√£ ƒêH</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Kh√°ch h√†ng</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">SƒêT</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">T·ªïng ti·ªÅn</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Tr·∫°ng th√°i</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Ng√†y ƒë·∫∑t</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${orders.map(order => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-semibold">#${order.don_hang_id}</td>
                                <td class="px-6 py-4">${order.ten_nguoi_nhan}</td>
                                <td class="px-6 py-4">${order.sdt_nguoi_nhan}</td>
                                <td class="px-6 py-4 font-semibold">${formatCurrency(order.tong_tien)}</td>
                                <td class="px-6 py-4">
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold" style="background-color: ${order.ma_mau_sac}20; color: ${order.ma_mau_sac}">
                                        ${order.ten_trang_thai}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-gray-600">${formatDate(order.ngay_dat_hang)}</td>
                                <td class="px-6 py-4">
                                    <button onclick="updateStatus(${order.don_hang_id}, ${order.trang_thai_don_hang_id})" class="text-blue-600 hover:text-blue-800 mr-3">
                                        ‚úèÔ∏è C·∫≠p nh·∫≠t
                                    </button>
                                    <a href="../order-detail.html?id=${order.don_hang_id}" class="text-primary hover:text-cyan-700">
                                        üëÅÔ∏è Xem
                                    </a>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateStatus(orderId, currentStatus) {
            document.getElementById('order-id').value = orderId;
            document.getElementById('trang_thai_don_hang_id').value = currentStatus;
            document.getElementById('status-modal').classList.remove('hidden');
        }

        function closeStatusModal() {
            document.getElementById('status-modal').classList.add('hidden');
        }

        // Filter orders
        document.getElementById('status-filter').addEventListener('change', (e) => {
            const statusId = e.target.value;
            if (statusId) {
                const filtered = allOrders.filter(o => o.trang_thai_don_hang_id == statusId);
                displayOrders(filtered);
            } else {
                displayOrders(allOrders);
            }
        });

        // Handle status update
        document.getElementById('status-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const orderId = document.getElementById('order-id').value;
            const statusId = document.getElementById('trang_thai_don_hang_id').value;

            try {
                await apiCall(`/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ trang_thai_don_hang_id: parseInt(statusId) })
                });
                
                alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
                closeStatusModal();
                loadOrders();
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        });

        // Auto refresh every 30 seconds
        let autoRefreshInterval;
        
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                loadOrders();
                console.log('üîÑ ƒê√£ c·∫≠p nh·∫≠t danh s√°ch ƒë∆°n h√†ng');
            }, 30000); // 30 gi√¢y
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        // Load initial data and start auto refresh
        loadOrders().then(() => {
            startAutoRefresh();
            console.log('‚úÖ T·ª± ƒë·ªông c·∫≠p nh·∫≠t ƒë∆°n h√†ng m·ªói 30 gi√¢y');
        });

        // Stop auto refresh when page is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>
